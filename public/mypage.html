<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>마이페이지 | 에니어그램 요가</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Noto+Serif+KR:wght@200;300;400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#f8f6f3;--text:#2c2c2c;--accent:#8a7968;--accent-light:#b8a99a;--border:#d4cdc4;--white:#fff;--section-bg:#f0ece7}
body{font-family:'Noto Serif KR',serif;color:var(--text);background:var(--bg);line-height:1.9;min-height:100vh;display:flex;flex-direction:column}
.eng{font-family:'Cormorant Garamond',serif;letter-spacing:0.08em}
nav{width:100%;background:rgba(248,246,243,0.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding:0 40px}
nav .inner{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;height:70px}
nav .logo{display:flex;align-items:center;text-decoration:none}
nav .logo img{height:36px;width:auto}
nav ul{list-style:none;display:flex;gap:36px}
nav ul li a{text-decoration:none;color:var(--text);font-size:0.75rem;letter-spacing:0.12em;text-transform:uppercase;font-family:'Cormorant Garamond',serif;font-weight:400;transition:color 0.3s;cursor:pointer}
nav ul li a:hover{color:var(--accent)}
.container{flex:1;max-width:900px;margin:0 auto;padding:60px 40px;width:100%}
.page-header{margin-bottom:50px}
.page-header .label{font-family:'Cormorant Garamond',serif;font-size:0.75rem;letter-spacing:0.35em;text-transform:uppercase;color:var(--accent);margin-bottom:8px}
.page-header h1{font-family:'Cormorant Garamond',serif;font-size:2.5rem;font-weight:300;letter-spacing:0.03em}
.page-header .welcome{font-size:0.85rem;color:#888;font-weight:300;margin-top:8px}
.temp-pw-banner{background:#fff8e1;border:1px solid #eed88a;padding:20px 24px;margin-bottom:30px;font-size:0.82rem;font-weight:300;line-height:1.8;display:none}
.temp-pw-banner strong{font-weight:500;color:#c49000}
.temp-pw-banner .change-pw-toggle{display:inline-block;margin-top:8px;padding:8px 24px;border:1px solid #c49000;background:transparent;color:#c49000;font-family:'Cormorant Garamond',serif;font-size:0.78rem;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:all 0.3s}
.temp-pw-banner .change-pw-toggle:hover{background:#c49000;color:var(--white)}
.pw-change-form{background:var(--white);border:1px solid var(--border);padding:30px;margin-bottom:30px;display:none}
.pw-change-form h3{font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:300;margin-bottom:20px}
.pw-change-form .form-group{margin-bottom:18px}
.pw-change-form .form-group label{display:block;font-size:0.7rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--accent);margin-bottom:6px;font-family:'Cormorant Garamond',serif}
.pw-change-form .form-group input{width:100%;padding:10px 0;border:none;border-bottom:1px solid var(--border);background:transparent;font-family:'Noto Serif KR',serif;font-size:0.85rem;font-weight:300;outline:none}
.pw-change-form .form-group input:focus{border-bottom-color:var(--accent)}
.pw-change-form .pw-btn{padding:10px 30px;border:1px solid var(--text);background:transparent;color:var(--text);font-family:'Cormorant Garamond',serif;font-size:0.78rem;letter-spacing:0.12em;text-transform:uppercase;cursor:pointer;transition:all 0.3s}
.pw-change-form .pw-btn:hover{background:var(--text);color:var(--white)}
.pw-change-form .pw-msg{font-size:0.78rem;margin-top:12px;font-weight:300}
.pw-change-form .pw-msg.success{color:#2e7d32}
.pw-change-form .pw-msg.error{color:#c44}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:24px;margin-bottom:50px}
.stat-card{background:var(--white);border:1px solid var(--border);padding:30px;text-align:center;transition:border-color 0.3s}
.stat-card:hover{border-color:var(--accent)}
.stat-card .num{font-family:'Cormorant Garamond',serif;font-size:2.8rem;font-weight:300;color:var(--accent);line-height:1}
.stat-card .num.small-text{font-size:1rem;font-weight:300;color:var(--accent);line-height:2.8}
.stat-card .num.expiry-warning{color:#c49000}
.stat-card .num.expiry-danger{color:#c44}
.stat-card .label{font-size:0.72rem;color:#888;margin-top:8px;font-weight:300}
.section-box{background:var(--white);border:1px solid var(--border);padding:40px;margin-bottom:30px}
.section-box h3{font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:300;letter-spacing:0.05em;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--border)}
.purchase-btn{display:inline-block;padding:12px 40px;border:1px solid var(--text);background:transparent;color:var(--text);font-family:'Cormorant Garamond',serif;font-size:0.8rem;letter-spacing:0.15em;text-transform:uppercase;cursor:pointer;transition:all 0.4s}
.purchase-btn:hover{background:var(--text);color:var(--white)}
table{width:100%;border-collapse:collapse;font-size:0.82rem}
table th{text-align:left;padding:12px 8px;border-bottom:2px solid var(--border);font-family:'Cormorant Garamond',serif;font-size:0.72rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--accent);font-weight:400}
table td{padding:12px 8px;border-bottom:1px solid var(--border);font-weight:300}
.badge{display:inline-block;padding:3px 12px;font-size:0.7rem;border-radius:2px;font-weight:400}
.badge-pending{background:#fff8e1;color:#c49000;border:1px solid #eed88a}
.badge-confirmed{background:#e8f5e9;color:#2e7d32;border:1px solid #a5d6a7}
.badge-active{background:#e3f2fd;color:#1565c0;border:1px solid #90caf9}
.badge-used{background:#f5f5f5;color:#888;border:1px solid #ddd}
.badge-expired{background:#fce4ec;color:#c62828;border:1px solid #ef9a9a}
.empty-state{text-align:center;padding:40px;color:#aaa;font-size:0.85rem;font-weight:300}
.bank-info-box{background:var(--section-bg);padding:20px;margin-top:16px;font-size:0.82rem;line-height:2;font-weight:300;display:none}
.bank-info-box strong{font-weight:500}
.pass-table .expiry-cell{font-size:0.78rem}
.pass-table .expiry-cell.near{color:#c49000;font-weight:400}
.pass-table .expiry-cell.expired{color:#c44;font-weight:400}
footer{padding:40px;border-top:1px solid var(--border);text-align:center;margin-top:auto}
footer .logo-img{height:28px;width:auto;margin-bottom:8px}
footer p{font-size:0.7rem;color:#999;font-weight:300}
@media(max-width:768px){nav ul{display:none}nav .logo img{height:28px}.stats-grid{grid-template-columns:repeat(2,1fr)}.container{padding:40px 20px}.section-box{padding:24px}}
.hamburger{display:none;background:none;border:none;font-size:1.5rem;color:var(--text);cursor:pointer}
@media(max-width:768px){.hamburger{display:block}nav ul{display:none;position:absolute;top:100%;left:0;right:0;background:var(--white);border-bottom:1px solid var(--border);padding:20px;flex-direction:column;gap:12px}nav ul.open{display:flex}}
</style>
</head>
<body>
<nav><div class="inner"><a href="/" class="logo"><img src="/images/signature.png" alt="Junseong Hwang"></a><ul><li><a href="/">Home</a></li><li><a onclick="logout()">Logout</a></li></ul><button class="hamburger" onclick="toggleMenu()">&#9776;</button></div></nav>
<div class="container">
<div class="page-header">
<p class="label eng">My Page</p>
<h1 class="eng">Your Practice</h1>
<p class="welcome" id="welcomeMsg">로딩 중...</p>
</div>
<div class="temp-pw-banner" id="tempPwBanner">
<strong>임시 비밀번호를 사용 중입니다.</strong><br>
보안을 위해 비밀번호를 변경해주세요.
<br><button class="change-pw-toggle" onclick="document.getElementById('pwChangeForm').style.display='block'">비밀번호 변경하기</button>
</div>
<div class="pw-change-form" id="pwChangeForm">
<h3 class="eng">Change Password</h3>
<div class="form-group"><label class="eng">Current Password</label><input type="password" id="currentPw" placeholder="현재 비밀번호 (SMS로 받은 비밀번호)"></div>
<div class="form-group"><label class="eng">New Password</label><input type="password" id="newPw" placeholder="새 비밀번호 (6자 이상)" minlength="6"></div>
<div class="form-group"><label class="eng">Confirm New Password</label><input type="password" id="newPwConfirm" placeholder="새 비밀번호 확인"></div>
<button class="pw-btn" onclick="changePassword()">Change Password</button>
<div class="pw-msg" id="pwMsg"></div>
</div>
<div class="stats-grid">
<div class="stat-card"><div class="num" id="remainingClasses">-</div><div class="label">잔여 수업 횟수</div></div>
<div class="stat-card"><div class="num small-text" id="expiryDate">-</div><div class="label">유효기간</div></div>
<div class="stat-card"><div class="num" id="totalAttended">-</div><div class="label">총 출석 횟수</div></div>
<div class="stat-card"><div class="num" id="activePasses">-</div><div class="label">보유 이용권</div></div>
</div>
<div class="section-box">
<h3 class="eng">Class Pass</h3>
<div id="passListSection">
<p style="font-size:0.85rem;font-weight:300;color:#666;margin-bottom:20px">12회 이용권 (99,000원)을 구매하시려면 아래 버튼을 눌러주세요.</p>
<button class="purchase-btn eng" onclick="requestPass()">Purchase Pass</button>
<div class="bank-info-box" id="bankInfo">
<strong>입금 계좌</strong><br>
농협 312-0025-5524-11<br>
<strong>예금주</strong> 황준성<br>
<strong>금액</strong> 99,000원<br><br>
입금 확인 후 이용권이 자동으로 활성화됩니다.
</div>
</div>
<div id="passTable" style="display:none;margin-top:20px"></div>
</div>
<div class="section-box">
<h3 class="eng">Payment History</h3>
<div id="paymentList"><div class="empty-state">결제 내역이 없습니다</div></div>
</div>
<div class="section-box">
<h3 class="eng">Attendance Record</h3>
<div id="attendanceList"><div class="empty-state">출석 기록이 없습니다</div></div>
</div>
</div>
<footer><img class="logo-img" src="/images/signature.png" alt="Junseong Hwang"><p>&copy; 2026 Junseong Hwang. All rights reserved.</p></footer>
<script>
let csrfToken='';
fetch('/api/csrf-token').then(r=>r.json()).then(d=>{csrfToken=d.csrfToken}).catch(()=>{});
function apiFetch(url,opts={}){if(!opts.headers)opts.headers={};opts.headers['Content-Type']=opts.headers['Content-Type']||'application/json';if(csrfToken)opts.headers['X-CSRF-Token']=csrfToken;return fetch(url,opts);}
async function checkAuth() {
  const res = await fetch('/api/me');
  const data = await res.json();
  if (!data.loggedIn) { window.location.href = '/login'; return; }
  if (data.user.role === 'admin') { window.location.href = '/admin'; return; }
  document.getElementById('welcomeMsg').textContent = data.user.name + '님, 환영합니다';
  loadMypage();
}
async function loadMypage() {
  try {
    const res = await fetch('/api/mypage');
    const data = await res.json();
    // Temp password banner
    if (data.user.password_is_temp) {
      document.getElementById('tempPwBanner').style.display = 'block';
    }
    // Stats
    let remaining = 0;
    let activeCount = 0;
    let nearestExpiry = null;
    data.passes.forEach(p => {
      if (p.status === 'active') {
        remaining += p.remaining_classes;
        activeCount++;
        if (p.expires_at) {
          const exp = new Date(p.expires_at);
          if (!nearestExpiry || exp < nearestExpiry) nearestExpiry = exp;
        }
      }
    });
    document.getElementById('remainingClasses').textContent = remaining;
    document.getElementById('totalAttended').textContent = data.attendance.length;
    document.getElementById('activePasses').textContent = activeCount;

    // Expiry date display
    const expiryEl = document.getElementById('expiryDate');
    if (nearestExpiry) {
      const now = new Date();
      const daysLeft = Math.ceil((nearestExpiry - now) / (1000 * 60 * 60 * 24));
      const expiryStr = nearestExpiry.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
      if (daysLeft <= 0) {
        expiryEl.textContent = '만료됨';
        expiryEl.className = 'num small-text expiry-danger';
      } else if (daysLeft <= 14) {
        expiryEl.textContent = expiryStr;
        expiryEl.className = 'num small-text expiry-warning';
      } else {
        expiryEl.textContent = expiryStr;
        expiryEl.className = 'num small-text';
      }
    } else {
      expiryEl.textContent = '-';
    }

    // Pass table
    if (data.passes.length > 0) {
      var html = '<table class="pass-table"><thead><tr><th>구매일</th><th>잔여/전체</th><th>유효기간</th><th>상태</th></tr></thead><tbody>';
      data.passes.forEach(function(p) {
        var purchDate = new Date(p.purchased_at).toLocaleDateString('ko-KR');
        var statusBadge = '';
        if (p.status === 'active') statusBadge = '<span class="badge badge-active">사용중</span>';
        else if (p.status === 'used') statusBadge = '<span class="badge badge-used">사용완료</span>';
        else statusBadge = '<span class="badge badge-used">' + p.status + '</span>';

        var expiryCell = '-';
        if (p.expires_at) {
          var expDate = new Date(p.expires_at);
          var now = new Date();
          var dLeft = Math.ceil((expDate - now) / (1000 * 60 * 60 * 24));
          var expStr = expDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'short', day: 'numeric' });
          if (dLeft <= 0) {
            expiryCell = '<span class="expiry-cell expired">' + expStr + ' (만료)</span>';
          } else if (dLeft <= 14) {
            expiryCell = '<span class="expiry-cell near">' + expStr + ' (D-' + dLeft + ')</span>';
          } else {
            expiryCell = '<span class="expiry-cell">' + expStr + '</span>';
          }
        }

        html += '<tr><td>' + purchDate + '</td><td>' + p.remaining_classes + '/' + p.total_classes + '</td><td>' + expiryCell + '</td><td>' + statusBadge + '</td></tr>';
      });
      html += '</tbody></table>';
      document.getElementById('passTable').innerHTML = html;
      document.getElementById('passTable').style.display = 'block';
    }

    // Payments
    if (data.payments.length > 0) {
      var pHtml = '<table><thead><tr><th>Date</th><th>Amount</th><th>Status</th></tr></thead><tbody>';
      data.payments.forEach(function(p) {
        var date = new Date(p.created_at).toLocaleDateString('ko-KR');
        var badge = p.status === 'confirmed' ? 'badge-confirmed' : 'badge-pending';
        var label = p.status === 'confirmed' ? '확인완료' : (p.status === 'underpaid' ? '추가입금필요' : '입금대기');
        if (p.status === 'underpaid') badge = 'badge-pending';
        pHtml += '<tr><td>' + date + '</td><td>' + p.amount.toLocaleString() + '원</td><td><span class="badge ' + badge + '">' + label + '</span></td></tr>';
      });
      pHtml += '</tbody></table>';
      document.getElementById('paymentList').innerHTML = pHtml;
    }
    // Attendance
    if (data.attendance.length > 0) {
      var aHtml = '<table><thead><tr><th>Date</th><th>Note</th></tr></thead><tbody>';
      data.attendance.forEach(function(a) {
        var date = new Date(a.attended_at).toLocaleDateString('ko-KR', { year:'numeric', month:'long', day:'numeric', weekday:'short' });
        aHtml += '<tr><td>' + date + '</td><td>' + (a.note || '-') + '</td></tr>';
      });
      aHtml += '</tbody></table>';
      document.getElementById('attendanceList').innerHTML = aHtml;
    }
  } catch (err) { console.error(err); }
}
async function changePassword() {
  var msgEl = document.getElementById('pwMsg');
  msgEl.textContent = '';
  msgEl.className = 'pw-msg';
  var currentPw = document.getElementById('currentPw').value;
  var newPw = document.getElementById('newPw').value;
  var newPwConfirm = document.getElementById('newPwConfirm').value;
  if (!currentPw || !newPw || !newPwConfirm) { msgEl.textContent = '모든 필드를 입력해주세요'; msgEl.className = 'pw-msg error'; return; }
  if (newPw.length < 8) { msgEl.textContent = '새 비밀번호는 8자 이상이어야 합니다'; msgEl.className = 'pw-msg error'; return; }
  if (newPw !== newPwConfirm) { msgEl.textContent = '새 비밀번호가 일치하지 않습니다'; msgEl.className = 'pw-msg error'; return; }
  try {
    var res = await apiFetch('/api/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ current_password: currentPw, new_password: newPw })
    });
    var data = await res.json();
    if (data.success) {
      msgEl.textContent = '비밀번호가 성공적으로 변경되었습니다!';
      msgEl.className = 'pw-msg success';
      document.getElementById('tempPwBanner').style.display = 'none';
      document.getElementById('pwChangeForm').style.display = 'none';
    } else {
      msgEl.textContent = data.error;
      msgEl.className = 'pw-msg error';
    }
  } catch (err) {
    msgEl.textContent = '서버 연결에 실패했습니다';
    msgEl.className = 'pw-msg error';
  }
}
async function requestPass() {
  try {
    var res = await apiFetch('/api/passes/request', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    var data = await res.json();
    if (data.success) {
      document.getElementById('bankInfo').style.display = 'block';
      loadMypage();
    }
  } catch (err) { console.error(err); }
}
async function logout() {
  await apiFetch('/api/logout', { method: 'POST' });
  window.location.href = '/';
}
function toggleMenu(){document.querySelector('nav ul').classList.toggle('open');}
checkAuth();
</script>
</body>
</html>
