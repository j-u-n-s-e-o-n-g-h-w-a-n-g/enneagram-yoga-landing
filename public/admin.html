<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê´€ë¦¬ì | ì—ë‹ˆì–´ê·¸ë¨ ìš”ê°€</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Noto+Serif+KR:wght@200;300;400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#f8f6f3;--text:#2c2c2c;--accent:#8a7968;--accent-light:#b8a99a;--border:#d4cdc4;--white:#fff;--section-bg:#f0ece7}
body{font-family:'Noto Serif KR',serif;color:var(--text);background:var(--bg);line-height:1.9;min-height:100vh;display:flex;flex-direction:column}
.eng{font-family:'Cormorant Garamond',serif;letter-spacing:0.08em}
nav{width:100%;background:rgba(248,246,243,0.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding:0 40px}
nav .inner{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;height:70px}
nav .logo{display:flex;align-items:center;text-decoration:none}
nav .logo img{height:36px;width:auto}
nav ul{list-style:none;display:flex;gap:36px}
nav ul li a{text-decoration:none;color:var(--text);font-size:0.75rem;letter-spacing:0.12em;text-transform:uppercase;font-family:'Cormorant Garamond',serif;font-weight:400;transition:color 0.3s;cursor:pointer}
nav ul li a:hover{color:var(--accent)}
.admin-badge{font-size:0.65rem;background:var(--accent);color:var(--white);padding:2px 8px;border-radius:2px;margin-left:8px;letter-spacing:0.1em}
.container{flex:1;max-width:1100px;margin:0 auto;padding:60px 40px;width:100%}
.page-header{margin-bottom:50px}
.page-header .label{font-family:'Cormorant Garamond',serif;font-size:0.75rem;letter-spacing:0.35em;text-transform:uppercase;color:var(--accent);margin-bottom:8px}
.page-header h1{font-family:'Cormorant Garamond',serif;font-size:2.5rem;font-weight:300;letter-spacing:0.03em}
.stats-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:20px;margin-bottom:50px}
.stat-card{background:var(--white);border:1px solid var(--border);padding:28px;text-align:center}
.stat-card .num{font-family:'Cormorant Garamond',serif;font-size:2.5rem;font-weight:300;color:var(--accent);line-height:1}
.stat-card .label{font-size:0.7rem;color:#888;margin-top:8px;font-weight:300}
.tabs{display:flex;gap:0;margin-bottom:30px;border-bottom:1px solid var(--border)}
.tab{padding:12px 30px;font-family:'Cormorant Garamond',serif;font-size:0.8rem;letter-spacing:0.12em;text-transform:uppercase;color:#888;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.3s;background:none;border-top:none;border-left:none;border-right:none}
.tab.active{color:var(--text);border-bottom-color:var(--accent)}
.tab-content{display:none}
.tab-content.active{display:block}
.section-box{background:var(--white);border:1px solid var(--border);padding:30px;margin-bottom:20px}
table{width:100%;border-collapse:collapse;font-size:0.8rem}
table th{text-align:left;padding:12px 8px;border-bottom:2px solid var(--border);font-family:'Cormorant Garamond',serif;font-size:0.7rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--accent);font-weight:400}
table td{padding:10px 8px;border-bottom:1px solid var(--border);font-weight:300;font-size:0.82rem}
table tr.clickable{cursor:pointer;transition:background 0.2s}
table tr.clickable:hover{background:var(--section-bg)}
.badge{display:inline-block;padding:3px 10px;font-size:0.68rem;border-radius:2px;font-weight:400}
.badge-pending{background:#fff8e1;color:#c49000;border:1px solid #eed88a}
.badge-confirmed{background:#e8f5e9;color:#2e7d32;border:1px solid #a5d6a7}
.badge-active{background:#e3f2fd;color:#1565c0;border:1px solid #90caf9}
.badge-used{background:#f3e5f5;color:#7b1fa2;border:1px solid #ce93d8}
.badge-expired{background:#fce4ec;color:#c62828;border:1px solid #ef9a9a}
.action-btn{padding:6px 16px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-family:'Cormorant Garamond',serif;font-size:0.72rem;letter-spacing:0.1em;cursor:pointer;transition:all 0.3s}
.action-btn:hover{background:var(--accent);color:var(--white)}
.action-btn.danger{border-color:#c44;color:#c44}
.action-btn.danger:hover{background:#c44;color:var(--white)}
.action-btn.small{padding:4px 12px;font-size:0.68rem}
.empty-state{text-align:center;padding:40px;color:#aaa;font-size:0.85rem;font-weight:300}
.filter-row{display:flex;gap:12px;margin-bottom:20px}
.filter-btn{padding:6px 16px;border:1px solid var(--border);background:transparent;color:#888;font-size:0.72rem;cursor:pointer;transition:all 0.3s;font-family:'Cormorant Garamond',serif;letter-spacing:0.1em}
.filter-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(138,121,104,0.05)}
/* Member Detail Panel */
.detail-panel{display:none;margin-bottom:30px}
.detail-panel.active{display:block}
.detail-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px}
.detail-header .back-btn{padding:8px 20px;border:1px solid var(--border);background:transparent;color:var(--text);font-family:'Noto Serif KR',serif;font-size:0.78rem;cursor:pointer;transition:all 0.3s}
.detail-header .back-btn:hover{border-color:var(--accent);color:var(--accent)}
.detail-info{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:24px}
.detail-info-item{padding:16px;background:var(--section-bg);border:1px solid var(--border)}
.detail-info-item .di-label{font-size:0.68rem;color:var(--accent);font-family:'Cormorant Garamond',serif;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:4px}
.detail-info-item .di-value{font-size:0.9rem;font-weight:400}
.detail-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:30px}
.detail-stat{background:var(--white);border:1px solid var(--border);padding:20px;text-align:center}
.detail-stat .ds-num{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:300;color:var(--accent)}
.detail-stat .ds-label{font-size:0.7rem;color:#888;font-weight:300;margin-top:4px}
.detail-tabs{display:flex;gap:0;margin-bottom:20px;border-bottom:1px solid var(--border)}
.detail-tab{padding:10px 24px;font-family:'Cormorant Garamond',serif;font-size:0.75rem;letter-spacing:0.1em;text-transform:uppercase;color:#888;cursor:pointer;border:none;border-bottom:2px solid transparent;background:none;transition:all 0.3s}
.detail-tab.active{color:var(--text);border-bottom-color:var(--accent)}
.detail-tab-content{display:none}
.detail-tab-content.active{display:block}
/* Edit Form */
.edit-form{display:none;margin-bottom:24px;padding:24px;background:var(--section-bg);border:1px solid var(--border)}
.edit-form.active{display:block}
.edit-form .form-row{display:flex;gap:12px;margin-bottom:12px;align-items:center}
.edit-form .form-row label{width:80px;font-size:0.78rem;font-weight:400;flex-shrink:0}
.edit-form .form-row input{flex:1;padding:8px 12px;border:1px solid var(--border);background:var(--white);font-family:'Noto Serif KR',serif;font-size:0.85rem;outline:none}
.edit-form .form-row input:focus{border-color:var(--accent)}
.edit-form .form-actions{display:flex;gap:8px;margin-top:16px}
.detail-action-bar{display:flex;gap:8px;margin-bottom:24px}
/* Confirm Dialog */
.confirm-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);z-index:1000;justify-content:center;align-items:center}
.confirm-overlay.active{display:flex}
.confirm-box{background:var(--white);padding:30px;border:1px solid var(--border);max-width:400px;width:90%;text-align:center}
.confirm-box p{font-size:0.88rem;margin-bottom:20px;line-height:1.7}
.confirm-box .confirm-actions{display:flex;gap:10px;justify-content:center}
/* Add Credits Form */
.add-credits-form{display:flex;gap:12px;align-items:center;margin-bottom:20px;padding:16px;background:var(--section-bg);border:1px solid var(--border)}
.add-credits-form label{font-size:0.78rem;font-weight:400;white-space:nowrap}
.add-credits-form input[type="number"]{width:80px;padding:8px 12px;border:1px solid var(--border);background:var(--white);font-family:'Noto Serif KR',serif;font-size:0.85rem;outline:none}
.add-credits-form input[type="number"]:focus{border-color:var(--accent)}
.add-credits-form input[type="text"]{flex:1;padding:8px 12px;border:1px solid var(--border);background:var(--white);font-family:'Noto Serif KR',serif;font-size:0.82rem;outline:none}
.add-credits-form input[type="text"]:focus{border-color:var(--accent)}
/* Loading spinner */
.loading{text-align:center;padding:30px;color:var(--accent)}
.loading::after{content:'';display:inline-block;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.6s linear infinite;margin-left:8px;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
/* Toast notification */
.toast{position:fixed;bottom:24px;right:24px;background:var(--text);color:var(--white);padding:14px 24px;border-radius:4px;font-size:0.82rem;z-index:2000;opacity:0;transform:translateY(10px);transition:all 0.3s;pointer-events:none}
.toast.show{opacity:1;transform:translateY(0)}
.toast.error{background:#c44}
.toast.success{background:#2e7d32}
/* Pagination */
.pagination{display:flex;justify-content:center;align-items:center;gap:8px;margin-top:16px;padding:12px 0}
.pagination button{padding:6px 14px;border:1px solid var(--border);background:transparent;color:var(--text);font-family:'Cormorant Garamond',serif;font-size:0.78rem;cursor:pointer;transition:all 0.2s}
.pagination button.active{background:var(--accent);color:var(--white);border-color:var(--accent)}
.pagination button:disabled{opacity:0.4;cursor:default}
.pagination .page-info{font-size:0.75rem;color:#888}
/* Date filter */
.date-filter{display:flex;gap:8px;align-items:center;margin-bottom:16px}
.date-filter input[type="date"]{padding:6px 10px;border:1px solid var(--border);font-family:'Noto Serif KR',serif;font-size:0.8rem;outline:none}
.date-filter input[type="date"]:focus{border-color:var(--accent)}
footer{padding:40px;border-top:1px solid var(--border);text-align:center;margin-top:auto}
footer .logo-img{height:28px;width:auto;margin-bottom:8px}
footer p{font-size:0.7rem;color:#999;font-weight:300}
.hamburger{display:none;background:none;border:none;font-size:1.5rem;color:var(--text);cursor:pointer}
@media(max-width:768px){.hamburger{display:block}nav ul{display:none;position:absolute;top:100%;left:0;right:0;background:var(--white);border-bottom:1px solid var(--border);padding:20px;flex-direction:column;gap:12px}nav ul.open{display:flex}nav{padding:0 24px}nav .logo img{height:28px}.stats-grid{grid-template-columns:repeat(2,1fr)}.container{padding:40px 16px}.section-box{padding:20px}table{font-size:0.72rem}.tabs{overflow-x:auto}.detail-info{grid-template-columns:1fr}.detail-stats{grid-template-columns:1fr}.add-credits-form{flex-direction:column;align-items:stretch}}
</style>
</head>
<body>
<nav><div class="inner"><a href="/" class="logo"><img src="/images/signature.png" alt="Junseong Hwang"><span class="admin-badge eng">ADMIN</span></a><ul><li><a href="/">Home</a></li><li><a onclick="logout()">Logout</a></li></ul><button class="hamburger" onclick="toggleMenu()">&#9776;</button></div></nav>
<div class="container">
<div class="page-header">
<p class="label eng">Admin Dashboard</p>
<h1 class="eng">Management</h1>
</div>
<div class="stats-grid">
<div class="stat-card"><div class="num" id="statMembers">0</div><div class="label">ì „ì²´ íšŒì›</div></div>
<div class="stat-card"><div class="num" id="statPending">0</div><div class="label">ì…ê¸ˆ ëŒ€ê¸°</div></div>
<div class="stat-card"><div class="num" id="statActive">0</div><div class="label">í™œì„± ì´ìš©ê¶Œ</div></div>
<div class="stat-card"><div class="num" id="statToday">0</div><div class="label">ì˜¤ëŠ˜ ì¶œì„</div></div>
<div class="stat-card"><div class="num" id="statApplications">0</div><div class="label">ì‹ ì²­ ëŒ€ê¸°</div></div>
</div>

<!-- Main List View -->
<div id="mainView">
<div class="tabs">
<button class="tab active" onclick="switchTab('payments')">ì…ê¸ˆ ê´€ë¦¬</button>
<button class="tab" onclick="switchTab('members')">íšŒì› ê´€ë¦¬</button>
<button class="tab" onclick="switchTab('applications')">ì‹ ì²­ ê´€ë¦¬</button>
<button class="tab" onclick="switchTab('bulk-sms')">ë‹¨ì²´ SMS</button>
<button class="tab" onclick="switchTab('attendance-history')">ìˆ˜ì—… ì´ë ¥</button>
<button class="tab" onclick="switchTab('messages')">ë©”ì‹œì§€ ì´ë ¥</button>
<button class="tab" onclick="switchTab('waitlist')">ëŒ€ê¸°ì ê´€ë¦¬</button>
</div>
<div class="tab-content active" id="tab-payments">
<div style="margin-bottom:16px"><input type="text" id="searchPayments" placeholder="ì´ë¦„, ì „í™”ë²ˆí˜¸, ì…ê¸ˆìëª…ìœ¼ë¡œ ê²€ìƒ‰..." style="width:100%;padding:10px;border:1px solid var(--border);font-family:'Noto Serif KR',serif;font-size:0.82rem;outline:none" onkeyup="if(event.key==='Enter')searchPaymentsFn()"><button class="action-btn small" style="margin-top:8px" onclick="searchPaymentsFn()">ê²€ìƒ‰</button></div>
<div style="display:flex;justify-content:space-between;align-items:center">
<div class="filter-row" style="margin-bottom:0">
<button class="filter-btn active" onclick="filterPayments('all', this)">ì „ì²´</button>
<button class="filter-btn" onclick="filterPayments('pending', this)">ì…ê¸ˆëŒ€ê¸°</button>
<button class="filter-btn" onclick="filterPayments('confirmed', this)">í™•ì¸ì™„ë£Œ</button>
</div>
<button class="action-btn small" onclick="exportCSV('payments')">ğŸ“¥ CSV</button>
</div>
<div class="section-box"><div id="paymentList"><div class="empty-state">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div><div id="paymentPagination"></div></div>
</div>
<div class="tab-content" id="tab-members">
<div style="display:flex;gap:8px;align-items:flex-end;margin-bottom:16px"><div style="flex:1"><input type="text" id="searchMembers" placeholder="ì´ë¦„, ì´ë©”ì¼, ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰..." style="width:100%;padding:10px;border:1px solid var(--border);font-family:'Noto Serif KR',serif;font-size:0.82rem;outline:none" onkeyup="if(event.key==='Enter')searchMembersFn()"><button class="action-btn small" style="margin-top:8px" onclick="searchMembersFn()">ê²€ìƒ‰</button></div><button class="action-btn small" onclick="exportCSV('members')">ğŸ“¥ CSV</button></div>
<div class="section-box"><div id="memberList"><div class="empty-state">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</div></div></div>
</div>
<div class="tab-content" id="tab-applications">
<div style="display:flex;justify-content:space-between;align-items:center">
<div class="filter-row" style="margin-bottom:0">
<button class="filter-btn active" onclick="filterApplications('all', this)">ì „ì²´</button>
<button class="filter-btn" onclick="filterApplications('pending', this)">ëŒ€ê¸°</button>
<button class="filter-btn" onclick="filterApplications('paid', this)">ì…ê¸ˆì™„ë£Œ</button>
</div>
<button class="action-btn small" onclick="exportCSV('applications')">ğŸ“¥ CSV</button>
</div>
<div class="section-box"><div id="applicationList"><div class="empty-state">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div></div>
</div>
<div class="tab-content" id="tab-bulk-sms">
<div class="filter-row" style="margin-bottom:16px">
<button class="filter-btn active" id="bulkTypeActive" onclick="switchBulkType('active', this)">ì´ìš©ê¶Œ ë³´ìœ  íšŒì›</button>
<button class="filter-btn" id="bulkTypeInactive" onclick="switchBulkType('inactive', this)">ì´ìš©ê¶Œ ë¯¸ë³´ìœ  íšŒì›</button>
</div>
<div class="section-box" style="margin-bottom:16px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<span style="font-size:0.82rem;font-weight:400">ë°œì†¡ ëŒ€ìƒ: <strong id="bulkTargetCount">0</strong>ëª…</span>
<button class="action-btn small" onclick="toggleBulkTargetList()">ëª©ë¡ ë³´ê¸°/ìˆ¨ê¸°ê¸°</button>
</div>
<div id="bulkTargetList" style="display:none;max-height:200px;overflow-y:auto;border:1px solid var(--border);padding:12px;font-size:0.78rem;font-weight:300;line-height:1.8"></div>
</div>
<div class="section-box">
<div style="margin-bottom:8px;font-size:0.72rem;color:var(--accent);font-weight:400;letter-spacing:0.1em">{name} = íšŒì› ì´ë¦„ìœ¼ë¡œ ìë™ ì¹˜í™˜</div>
<textarea id="bulkSmsMessage" placeholder="{name}ë‹˜, [ë°ì¼ë¦¬ ìš”ê°€ í´ë˜ìŠ¤] ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="width:100%;min-height:120px;padding:12px;border:1px solid var(--border);font-family:'Noto Serif KR',serif;font-size:0.82rem;font-weight:300;line-height:1.8;resize:vertical;outline:none" oninput="updateBulkCharCount()"></textarea>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
<span style="font-size:0.72rem;color:#888" id="bulkCharCount">0ì (SMS)</span>
<div style="display:flex;gap:8px">
<button class="action-btn small" onclick="previewBulkSms()">ë¯¸ë¦¬ë³´ê¸°</button>
<button class="action-btn" onclick="sendBulkSms()" style="background:var(--accent);color:var(--white);border-color:var(--accent)">ğŸ“± ì „ì²´ ë°œì†¡</button>
</div>
</div>
<div id="bulkPreview" style="display:none;margin-top:12px;padding:12px;background:var(--section-bg);font-size:0.82rem;font-weight:300;line-height:1.8;white-space:pre-wrap"></div>
</div>
<div id="bulkResult" style="display:none;margin-top:16px" class="section-box">
<div style="font-size:0.85rem;font-weight:400;margin-bottom:8px">ë°œì†¡ ê²°ê³¼</div>
<div id="bulkResultContent"></div>
</div>
</div>
</div>
<div class="tab-content" id="tab-attendance-history">
<div style="display:flex;gap:12px;align-items:flex-end;margin-bottom:16px;flex-wrap:wrap">
<div class="date-filter" style="margin-bottom:0">
<label style="font-size:0.78rem;white-space:nowrap">ê¸°ê°„:</label>
<input type="date" id="attDateFrom">
<span style="font-size:0.78rem">~</span>
<input type="date" id="attDateTo">
</div>
<div style="flex:1;min-width:180px"><input type="text" id="searchAttendance" placeholder="ì´ë¦„, ì´ë©”ì¼, ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰..." style="width:100%;padding:8px 10px;border:1px solid var(--border);font-family:'Noto Serif KR',serif;font-size:0.8rem;outline:none" onkeyup="if(event.key==='Enter')loadAttendanceHistory()"></div>
<button class="action-btn small" onclick="loadAttendanceHistory()">ê²€ìƒ‰</button>
</div>
<div class="section-box">
<div id="attendanceHistoryList"><div class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div></div>
<div id="attendancePagination"></div>
</div>
</div>
<div class="tab-content" id="tab-messages">
<div style="display:flex;gap:12px;align-items:flex-end;margin-bottom:16px;flex-wrap:wrap">
<div class="date-filter" style="margin-bottom:0">
<label style="font-size:0.78rem;white-space:nowrap">ê¸°ê°„:</label>
<input type="date" id="msgDateFrom">
<span style="font-size:0.78rem">~</span>
<input type="date" id="msgDateTo">
</div>
<div class="filter-row" style="margin-bottom:0">
<button class="filter-btn active" onclick="filterMessages('all', this)">ì „ì²´</button>
<button class="filter-btn" onclick="filterMessages('sms', this)">SMS</button>
<button class="filter-btn" onclick="filterMessages('email', this)">ì´ë©”ì¼</button>
<button class="filter-btn" onclick="filterMessages('cashreceipt', this)">í˜„ê¸ˆì˜ìˆ˜ì¦</button>
</div>
<div style="flex:1;min-width:180px"><input type="text" id="searchMessages" placeholder="ì´ë¦„, ì „í™”ë²ˆí˜¸, ì´ë©”ì¼ë¡œ ê²€ìƒ‰..." style="width:100%;padding:8px 10px;border:1px solid var(--border);font-family:'Noto Serif KR',serif;font-size:0.8rem;outline:none" onkeyup="if(event.key==='Enter')loadMessageHistory()"></div>
<button class="action-btn small" onclick="loadMessageHistory()">ê²€ìƒ‰</button>
</div>
<div class="section-box">
<div id="messageList"><div class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div></div>
<div id="messagePagination"></div>
</div>
</div>

<div class="tab-content" id="tab-waitlist">
<div style="display:flex;gap:12px;align-items:flex-end;margin-bottom:16px;flex-wrap:wrap">
<div class="filter-row" style="margin-bottom:0">
<button class="filter-btn active" onclick="filterWaitlist('all', this)">ì „ì²´</button>
<button class="filter-btn" onclick="filterWaitlist('premium', this)">Premium</button>
<button class="filter-btn" onclick="filterWaitlist('vip', this)">VIP</button>
</div>
<div class="filter-row" style="margin-bottom:0">
<button class="filter-btn active" onclick="filterWaitlistStatus('all', this)">ëª¨ë“  ìƒíƒœ</button>
<button class="filter-btn" onclick="filterWaitlistStatus('pending', this)">ëŒ€ê¸°ì¤‘</button>
<button class="filter-btn" onclick="filterWaitlistStatus('contacted', this)">ì—°ë½ì™„ë£Œ</button>
<button class="filter-btn" onclick="filterWaitlistStatus('converted', this)">ì „í™˜ì™„ë£Œ</button>
</div>
<div style="flex:1;min-width:180px"><input type="text" id="searchWaitlist" placeholder="ì´ë¦„, ì „í™”ë²ˆí˜¸, ì´ë©”ì¼ë¡œ ê²€ìƒ‰..." style="width:100%;padding:8px 10px;border:1px solid var(--border);font-family:'Noto Serif KR',serif;font-size:0.8rem;outline:none" onkeyup="if(event.key==='Enter')loadWaitlist()"></div>
<button class="action-btn small" onclick="loadWaitlist()">ê²€ìƒ‰</button>
</div>
<div class="section-box">
<table>
<thead><tr><th>ì´ë¦„</th><th>ì—°ë½ì²˜</th><th>ì´ë©”ì¼</th><th>ë©¤ë²„ì‹­</th><th>ìƒíƒœ</th><th>ì‹ ì²­ì¼</th><th>ê´€ë¦¬</th></tr></thead>
<tbody id="waitlistTableBody"><tr><td colspan="7" style="text-align:center;padding:30px;color:#888">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</td></tr></tbody>
</table>
<div id="waitlistPagination" style="margin-top:16px"></div>
</div>
</div>

<!-- Member Detail View -->
<div class="detail-panel" id="detailPanel">
<div class="detail-header">
<div>
<p class="label eng" style="font-family:'Cormorant Garamond',serif;font-size:0.75rem;letter-spacing:0.35em;text-transform:uppercase;color:var(--accent);margin-bottom:8px">Member Detail</p>
<h2 class="eng" style="font-family:'Cormorant Garamond',serif;font-size:1.8rem;font-weight:300" id="detailName"></h2>
</div>
<button class="detail-header .back-btn" style="padding:8px 20px;border:1px solid var(--border);background:transparent;color:var(--text);font-family:'Noto Serif KR',serif;font-size:0.78rem;cursor:pointer" onclick="closeDetail()">â† ëª©ë¡ìœ¼ë¡œ</button>
</div>
<div class="detail-action-bar">
<button class="action-btn" onclick="toggleEditForm()">âœï¸ ì •ë³´ ìˆ˜ì •</button>
<button class="action-btn danger" onclick="showDeleteConfirm()">ğŸ—‘ íšŒì› ì‚­ì œ</button>
</div>

<div class="edit-form" id="editForm">
<div class="form-row"><label>ì´ë¦„</label><input type="text" id="editName"></div>
<div class="form-row"><label>ì´ë©”ì¼</label><input type="text" id="editEmail"></div>
<div class="form-row"><label>ì—°ë½ì²˜</label><input type="text" id="editPhone"></div>
<div class="form-actions">
<button class="action-btn" onclick="saveMemberEdit()">ì €ì¥</button>
<button class="action-btn" onclick="toggleEditForm()" style="color:#888;border-color:#ccc">ì·¨ì†Œ</button>
</div>
</div>

<div class="detail-info" id="detailInfo"></div>
<div class="detail-stats" id="detailStats"></div>

<div class="detail-tabs">
<button class="detail-tab active" onclick="switchDetailTab('attendance', this)">ì¶œì„ ë¡œê·¸</button>
<button class="detail-tab" onclick="switchDetailTab('passes', this)">ì´ìš©ê¶Œ</button>
<button class="detail-tab" onclick="switchDetailTab('payments-detail', this)">ê²°ì œ ë‚´ì—­</button>
<button class="detail-tab" onclick="switchDetailTab('notifications', this)">ì•Œë¦¼ ë‚´ì—­</button>
</div>

<div class="detail-tab-content active" id="dtab-attendance">
<div class="section-box"><div id="detailAttendance"><div class="empty-state">ì¶œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div></div></div>
</div>
<div class="detail-tab-content" id="dtab-passes">
<div class="add-credits-form">
<label>ì´ìš©ê¶Œ íšŸìˆ˜ ì¶”ê°€:</label>
<input type="number" id="addCreditsCount" min="1" max="100" value="1" placeholder="íšŸìˆ˜">
<input type="text" id="addCreditsNote" placeholder="ë©”ëª¨ (ì„ íƒ)">
<button class="action-btn" onclick="addCredits()">ì¶”ê°€</button>
</div>
<div class="add-credits-form" style="border-color:#e57373">
<label style="color:#c44">ì´ìš©ê¶Œ íšŸìˆ˜ ì°¨ê°:</label>
<input type="number" id="deductCreditsCount" min="1" max="100" value="1" placeholder="íšŸìˆ˜">
<input type="text" id="deductCreditsNote" placeholder="ì°¨ê° ì‚¬ìœ  (ì„ íƒ)">
<button class="action-btn danger" onclick="deductCredits()">ì°¨ê°</button>
</div>
<div class="section-box"><div id="detailPasses"><div class="empty-state">ì´ìš©ê¶Œì´ ì—†ìŠµë‹ˆë‹¤</div></div></div>
<div style="margin-top:20px">
<div style="font-size:0.82rem;font-weight:500;margin-bottom:8px;color:var(--text)">íšŸìˆ˜ ì¶”ê°€ ì´ë ¥</div>
<div class="section-box"><div id="detailCreditLogs"><div class="empty-state">ì¶”ê°€ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div></div></div>
</div>
</div>
<div class="detail-tab-content" id="dtab-payments-detail">
<div class="section-box"><div id="detailPayments"><div class="empty-state">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div></div>
</div>
<div class="detail-tab-content" id="dtab-notifications">
<div style="display:flex;gap:8px;margin-bottom:16px">
<button class="action-btn small" onclick="resendNotification('sms')">ğŸ“± SMS ì¬ë°œì†¡</button>
<button class="action-btn small" onclick="resendNotification('email')">ğŸ“§ ì´ë©”ì¼ ì¬ë°œì†¡</button>
<button class="action-btn small" onclick="resendNotification('cashreceipt')">ğŸ§¾ í˜„ê¸ˆì˜ìˆ˜ì¦ ì¬ë°œí–‰</button>
</div>
<div class="section-box"><div id="detailNotifications"><div class="empty-state">ì•Œë¦¼ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div></div>
</div>
</div>
</div>
<div class="confirm-overlay" id="deleteConfirm">
<div class="confirm-box">
<p><strong id="deleteTargetName"></strong> íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><span style="font-size:0.76rem;color:#c44">íšŒì› ì •ë³´ê°€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤. (ë³µêµ¬ ê°€ëŠ¥)</span></p>
<div class="confirm-actions">
<button class="action-btn danger" onclick="deleteMember()">ì‚­ì œ</button>
<button class="action-btn" onclick="hideDeleteConfirm()">ì·¨ì†Œ</button>
</div>
</div>
</div>
<!-- Application Edit Overlay -->
<div class="confirm-overlay" id="appEditOverlay">
<div class="confirm-box" style="text-align:left;max-width:440px">
<p style="font-size:0.9rem;font-weight:500;margin-bottom:16px">ì‹ ì²­ ì •ë³´ ìˆ˜ì •</p>
<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px">
<div style="display:flex;gap:10px;align-items:center"><label style="width:60px;font-size:0.78rem;flex-shrink:0">ì´ë¦„</label><input type="text" id="appEditName" style="flex:1;padding:8px 12px;border:1px solid var(--border);font-family:'Noto Serif KR',serif;font-size:0.85rem;outline:none"></div>
<div style="display:flex;gap:10px;align-items:center"><label style="width:60px;font-size:0.78rem;flex-shrink:0">ì´ë©”ì¼</label><input type="text" id="appEditEmail" style="flex:1;padding:8px 12px;border:1px solid var(--border);font-family:'Noto Serif KR',serif;font-size:0.85rem;outline:none"></div>
<div style="display:flex;gap:10px;align-items:center"><label style="width:60px;font-size:0.78rem;flex-shrink:0">ì—°ë½ì²˜</label><input type="text" id="appEditPhone" style="flex:1;padding:8px 12px;border:1px solid var(--border);font-family:'Noto Serif KR',serif;font-size:0.85rem;outline:none"></div>
</div>
<div class="confirm-actions">
<button class="action-btn" onclick="saveAppEdit()">ì €ì¥</button>
<button class="action-btn" onclick="closeAppEdit()" style="color:#888;border-color:#ccc">ì·¨ì†Œ</button>
</div>
</div>
</div>
<div class="toast" id="toast"></div>
<footer><img class="logo-img" src="/images/signature.png" alt="Junseong Hwang"><p>&copy; 2026 Junseong Hwang. All rights reserved.</p></footer>
<script>
let currentMemberId = null;
let paymentPage = 1;
const PAGE_SIZE = 20;
let currentPaymentStatus = 'all';
let currentPaymentSearch = '';
let csrfToken = '';

// Load CSRF token on page load
fetch('/api/csrf-token').then(r=>r.json()).then(d=>{csrfToken=d.csrfToken}).catch(()=>{});

function apiFetch(url, options = {}) {
  if (!options.headers) options.headers = {};
  if (!(options.body instanceof FormData)) options.headers['Content-Type'] = options.headers['Content-Type'] || 'application/json';
  if (csrfToken) options.headers['X-CSRF-Token'] = csrfToken;
  return fetch(url, options);
}

function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + type + ' show';
  setTimeout(() => t.classList.remove('show'), 3000);
}

function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;');
}

function showLoading(id) {
  document.getElementById(id).innerHTML = '<div class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>';
}

function renderPagination(containerId, currentPage, totalPages, onPageChange) {
  if (totalPages <= 1) { document.getElementById(containerId).innerHTML = ''; return; }
  let html = '<div class="pagination">';
  html += '<button ' + (currentPage <= 1 ? 'disabled' : '') + ' onclick="' + onPageChange + '(' + (currentPage - 1) + ')">â†</button>';
  const start = Math.max(1, currentPage - 2);
  const end = Math.min(totalPages, currentPage + 2);
  if (start > 1) html += '<button onclick="' + onPageChange + '(1)">1</button><span class="page-info">...</span>';
  for (let i = start; i <= end; i++) {
    html += '<button class="' + (i === currentPage ? 'active' : '') + '" onclick="' + onPageChange + '(' + i + ')">' + i + '</button>';
  }
  if (end < totalPages) html += '<span class="page-info">...</span><button onclick="' + onPageChange + '(' + totalPages + ')">' + totalPages + '</button>';
  html += '<button ' + (currentPage >= totalPages ? 'disabled' : '') + ' onclick="' + onPageChange + '(' + (currentPage + 1) + ')">â†’</button>';
  html += '</div>';
  document.getElementById(containerId).innerHTML = html;
}

async function checkAuth() {
  const res = await apiFetch('/api/me');
  const data = await res.json();
  if (!data.loggedIn) { window.location.href = '/login'; return; }
  if (data.user.role !== 'admin') { window.location.href = '/mypage'; return; }
  loadDashboard();
}

async function loadDashboard() {
  loadStats();
  loadPayments('all');
  loadMembers();
  loadApplications('all');
}

async function loadStats() {
  try {
    const res = await apiFetch('/api/admin/stats');
    const data = await res.json();
    document.getElementById('statMembers').textContent = data.totalMembers;
    document.getElementById('statPending').textContent = data.pendingPayments;
    document.getElementById('statActive').textContent = data.activePasses;
    document.getElementById('statToday').textContent = data.todayAttendance;
    document.getElementById('statApplications').textContent = data.pendingApplications || 0;
  } catch (err) { console.error(err); }
}

async function loadPayments(status, search, page) {
  if (status !== undefined) currentPaymentStatus = status;
  if (search !== undefined) currentPaymentSearch = search;
  if (page !== undefined) paymentPage = page;
  showLoading('paymentList');
  try {
    const res = await apiFetch('/api/admin/payments?status=' + currentPaymentStatus + (currentPaymentSearch ? '&search=' + encodeURIComponent(currentPaymentSearch) : '') + '&page=' + paymentPage + '&limit=' + PAGE_SIZE);
    const data = await res.json();
    const payments = data.payments || [];
    const total = (data.pagination && data.pagination.total) || data.total || payments.length;
    const totalPages = Math.ceil(total / PAGE_SIZE) || 1;
    if (payments.length === 0) {
      document.getElementById('paymentList').innerHTML = '<div class="empty-state">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      document.getElementById('paymentPagination').innerHTML = '';
      return;
    }
    let html = '<table><thead><tr><th>Date</th><th>Member</th><th>Phone</th><th>Depositor</th><th>Amount</th><th>Status</th><th>Action</th></tr></thead><tbody>';
    payments.forEach(p => {
      const date = new Date(p.created_at).toLocaleDateString('ko-KR');
      const badge = p.status === 'confirmed' ? 'badge-confirmed' : 'badge-pending';
      const label = p.status === 'confirmed' ? 'í™•ì¸ì™„ë£Œ' : 'ì…ê¸ˆëŒ€ê¸°';
      let action = '';
      if (p.status === 'pending') {
        action = '<button class="action-btn" onclick="confirmPayment(' + p.id + ')">ì…ê¸ˆí™•ì¸</button>';
      } else {
        const confirmedDate = new Date(p.confirmed_at).toLocaleDateString('ko-KR');
        action = '<span style="font-size:0.7rem;color:#888">' + confirmedDate + ' í™•ì¸</span>';
      }
      action += ' <button class="action-btn danger" style="margin-left:4px;padding:4px 10px;font-size:0.65rem" onclick="deletePayment(' + p.id + ',\'' + escapeHtml((p.user_name||'').replace(/'/g,"\\'")) + '\',' + p.amount + ')">ì‚­ì œ</button>';
      html += '<tr><td>' + date + '</td><td>' + escapeHtml(p.user_name) + '</td><td>' + escapeHtml(p.user_phone) + '</td><td>' + escapeHtml(p.depositor_name || '-') + '</td><td>' + p.amount.toLocaleString() + 'ì›</td><td><span class="badge ' + badge + '">' + label + '</span></td><td>' + action + '</td></tr>';
    });
    html += '</tbody></table>';
    document.getElementById('paymentList').innerHTML = html;
    renderPagination('paymentPagination', paymentPage, totalPages, 'goPaymentPage');
  } catch (err) { console.error(err); }
}
function goPaymentPage(page) { loadPayments(undefined, undefined, page); }

async function loadMembers(search) {
  showLoading('memberList');
  try {
    const res = await apiFetch('/api/admin/members' + (search ? '?search=' + encodeURIComponent(search) : ''));
    const data = await res.json();
    if (data.members.length === 0) {
      document.getElementById('memberList').innerHTML = '<div class="empty-state">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }
    let html = '<table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Remaining</th><th>Attended</th><th>Joined</th><th>Action</th></tr></thead><tbody>';
    data.members.forEach(m => {
      const date = new Date(m.created_at).toLocaleDateString('ko-KR');
      html += '<tr class="clickable" onclick="openMemberDetail(' + m.id + ')"><td><strong>' + escapeHtml(m.name) + '</strong></td><td>' + escapeHtml(m.email) + '</td><td>' + escapeHtml(m.phone) + '</td><td><strong>' + m.remaining_classes + 'íšŒ</strong></td><td>' + m.total_attended + 'íšŒ</td><td>' + date + '</td><td><button class="action-btn small" onclick="event.stopPropagation();markAttend(' + m.id + ')">ì¶œì„</button></td></tr>';
    });
    html += '</tbody></table>';
    document.getElementById('memberList').innerHTML = html;
  } catch (err) { console.error(err); }
}

async function loadApplications(status){
  try{
    const res=await apiFetch('/api/admin/applications?status='+status);
    const data=await res.json();
    if(!data.applications||data.applications.length===0){
      document.getElementById('applicationList').innerHTML='<div class="empty-state">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }
    let html='<table><thead><tr><th>Date</th><th>Name</th><th>Email</th><th>Phone</th><th>Status</th><th>Action</th></tr></thead><tbody>';
    data.applications.forEach(a=>{
      const date=new Date(a.created_at).toLocaleDateString('ko-KR');
      const badge=a.status==='paid'?'badge-confirmed':'badge-pending';
      const label=a.status==='paid'?'ì…ê¸ˆì™„ë£Œ':'ëŒ€ê¸°';
      const safeN=escapeHtml(a.name).replace(/'/g,"\\'");
      const safeE=escapeHtml(a.email).replace(/'/g,"\\'");
      const safeP=escapeHtml(a.phone||'').replace(/'/g,"\\'");
      html+='<tr><td>'+date+'</td><td>'+escapeHtml(a.name)+'</td><td>'+escapeHtml(a.email)+'</td><td>'+escapeHtml(a.phone)+'</td><td><span class="badge '+badge+'">'+label+'</span></td><td><button class="action-btn small" onclick="event.stopPropagation();openAppEdit('+a.id+',\''+safeN+'\',\''+safeE+'\',\''+safeP+'\')">ìˆ˜ì •</button> <button class="action-btn small danger" onclick="event.stopPropagation();deleteApplication('+a.id+',\''+safeN+'\')">ì‚­ì œ</button></td></tr>';
    });
    html+='</tbody></table>';
    document.getElementById('applicationList').innerHTML=html;
  }catch(err){console.error(err);}
}
function filterApplications(status,btn){
  document.querySelectorAll('#tab-applications .filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  loadApplications(status);
}

// ========== Member Detail ==========

async function openMemberDetail(userId) {
  currentMemberId = userId;
  try {
    const res = await apiFetch('/api/admin/members/' + userId);
    const data = await res.json();
    if (data.error) { showToast(data.error, 'error'); return; }

    // Hide main, show detail
    document.getElementById('mainView').style.display = 'none';
    document.getElementById('detailPanel').classList.add('active');

    // Store for edit form
    currentMemberData = data.user;
    // Close edit form if open
    document.getElementById('editForm').classList.remove('active');

    // Header
    document.getElementById('detailName').textContent = data.user.name;

    // Info
    const joined = new Date(data.user.created_at).toLocaleDateString('ko-KR');
    document.getElementById('detailInfo').innerHTML =
      '<div class="detail-info-item"><div class="di-label">Email</div><div class="di-value">' + escapeHtml(data.user.email) + '</div></div>' +
      '<div class="detail-info-item"><div class="di-label">Phone</div><div class="di-value">' + escapeHtml(data.user.phone) + '</div></div>' +
      '<div class="detail-info-item"><div class="di-label">Joined</div><div class="di-value">' + joined + '</div></div>';

    // Stats
    document.getElementById('detailStats').innerHTML =
      '<div class="detail-stat"><div class="ds-num">' + data.stats.total_remaining + '</div><div class="ds-label">ì”ì—¬ íšŸìˆ˜</div></div>' +
      '<div class="detail-stat"><div class="ds-num">' + data.stats.total_attended + '</div><div class="ds-label">ì´ ì¶œì„</div></div>' +
      '<div class="detail-stat"><div class="ds-num">' + data.stats.active_passes + '</div><div class="ds-label">í™œì„± ì´ìš©ê¶Œ</div></div>';

    // Attendance Log
    renderAttendanceLog(data.attendance);

    // Passes
    renderPasses(data.passes);

    // Credit Logs
    renderCreditLogs(data.credit_logs);

    // Payments
    renderPaymentsDetail(data.payments);

    // Notifications
    loadNotifications(userId);

    // Reset to first detail tab
    switchDetailTab('attendance');

  } catch (err) {
    console.error(err);
    showToast('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
  }
}

function renderAttendanceLog(attendance) {
  if (!attendance || attendance.length === 0) {
    document.getElementById('detailAttendance').innerHTML = '<div class="empty-state">ì¶œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  let html = '<table><thead><tr><th>#</th><th>Date</th><th>Time</th><th>Note</th></tr></thead><tbody>';
  attendance.forEach((a, i) => {
    const dt = new Date(a.attended_at);
    const date = dt.toLocaleDateString('ko-KR');
    const time = dt.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    const note = escapeHtml(a.note || '-');
    html += '<tr><td>' + (i + 1) + '</td><td>' + date + '</td><td>' + time + '</td><td style="font-size:0.76rem;color:#888">' + note + '</td></tr>';
  });
  html += '</tbody></table>';
  document.getElementById('detailAttendance').innerHTML = html;
}

function renderPasses(passes) {
  if (!passes || passes.length === 0) {
    document.getElementById('detailPasses').innerHTML = '<div class="empty-state">ì´ìš©ê¶Œì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  let html = '<table><thead><tr><th>ID</th><th>Total</th><th>Remaining</th><th>Status</th><th>Purchased</th><th>Expires</th></tr></thead><tbody>';
  passes.forEach(p => {
    const purchased = new Date(p.purchased_at).toLocaleDateString('ko-KR');
    const expires = p.expires_at ? new Date(p.expires_at).toLocaleDateString('ko-KR') : '-';
    let badgeClass = 'badge-active';
    let statusLabel = p.status;
    if (p.status === 'active') { badgeClass = 'badge-active'; statusLabel = 'í™œì„±'; }
    else if (p.status === 'used') { badgeClass = 'badge-used'; statusLabel = 'ì†Œì§„'; }
    else if (p.status === 'expired') { badgeClass = 'badge-expired'; statusLabel = 'ë§Œë£Œ'; }
    else if (p.status === 'cancelled') { badgeClass = 'badge-expired'; statusLabel = 'ì·¨ì†Œ'; }
    html += '<tr><td>' + p.id + '</td><td>' + p.total_classes + 'íšŒ</td><td><strong>' + p.remaining_classes + 'íšŒ</strong></td><td><span class="badge ' + badgeClass + '">' + statusLabel + '</span></td><td>' + purchased + '</td><td>' + expires + '</td></tr>';
  });
  html += '</tbody></table>';
  document.getElementById('detailPasses').innerHTML = html;
}

function renderCreditLogs(logs) {
  if (!logs || logs.length === 0) {
    document.getElementById('detailCreditLogs').innerHTML = '<div class="empty-state">ì¶”ê°€ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  let html = '<table><thead><tr><th>ë‚ ì§œ</th><th>ë³€ê²½ íšŸìˆ˜</th><th>ì´ìš©ê¶Œ ID</th><th>ë©”ëª¨</th></tr></thead><tbody>';
  logs.forEach(l => {
    const dt = new Date(l.created_at);
    const date = dt.toLocaleDateString('ko-KR');
    const time = dt.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    const creditColor = l.credits > 0 ? '#2e7d32' : '#c62828';
    const creditText = (l.credits > 0 ? '+' : '') + l.credits + 'íšŒ';
    html += '<tr><td>' + date + ' ' + time + '</td><td><strong style="color:' + creditColor + '">' + creditText + '</strong></td><td>' + (l.class_pass_id || '-') + '</td><td style="font-size:0.76rem;color:#888">' + escapeHtml(l.note || '-') + '</td></tr>';
  });
  html += '</tbody></table>';
  document.getElementById('detailCreditLogs').innerHTML = html;
}

function renderPaymentsDetail(payments) {
  if (!payments || payments.length === 0) {
    document.getElementById('detailPayments').innerHTML = '<div class="empty-state">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  let html = '<table><thead><tr><th>Date</th><th>Amount</th><th>Depositor</th><th>Status</th><th>Confirmed</th></tr></thead><tbody>';
  payments.forEach(p => {
    const date = new Date(p.created_at).toLocaleDateString('ko-KR');
    const badge = p.status === 'confirmed' ? 'badge-confirmed' : 'badge-pending';
    const label = p.status === 'confirmed' ? 'í™•ì¸ì™„ë£Œ' : p.status === 'underpaid' ? 'ë¶€ì¡±' : 'ëŒ€ê¸°';
    const confirmed = p.confirmed_at ? new Date(p.confirmed_at).toLocaleDateString('ko-KR') : '-';
    html += '<tr><td>' + date + '</td><td>' + p.amount.toLocaleString() + 'ì›</td><td>' + escapeHtml(p.depositor_name || '-') + '</td><td><span class="badge ' + badge + '">' + label + '</span></td><td>' + confirmed + '</td></tr>';
  });
  html += '</tbody></table>';
  document.getElementById('detailPayments').innerHTML = html;
}

async function addCredits() {
  if (!currentMemberId) return;
  const credits = parseInt(document.getElementById('addCreditsCount').value);
  const note = document.getElementById('addCreditsNote').value;
  if (!credits || credits < 1) { showToast('ì¶”ê°€í•  íšŸìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
  if (!confirm(credits + 'íšŒë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

  try {
    const res = await apiFetch('/api/admin/members/' + currentMemberId + '/add-credits', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ credits, note })
    });
    const data = await res.json();
    if (data.success) {
      showToast(data.added + 'íšŒê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ ì”ì—¬: ' + data.total_remaining + 'íšŒ', 'success');
      document.getElementById('addCreditsCount').value = '1';
      document.getElementById('addCreditsNote').value = '';
      openMemberDetail(currentMemberId);
      loadStats();
    } else {
      showToast(data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
  } catch (err) {
    showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

function closeDetail() {
  currentMemberId = null;
  document.getElementById('detailPanel').classList.remove('active');
  document.getElementById('mainView').style.display = 'block';
  loadMembers();
  loadStats();
}

async function loadNotifications(userId) {
  try {
    const res = await apiFetch('/api/admin/members/' + userId + '/notifications');
    const data = await res.json();
    renderNotifications(data.notifications);
  } catch (err) { console.error(err); }
}

function renderNotifications(notifications) {
  if (!notifications || notifications.length === 0) {
    document.getElementById('detailNotifications').innerHTML = '<div class="empty-state">ì•Œë¦¼ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  const typeLabels = { sms: 'ğŸ“± SMS', email: 'ğŸ“§ ì´ë©”ì¼', cashreceipt: 'ğŸ§¾ í˜„ê¸ˆì˜ìˆ˜ì¦' };
  let html = '<table><thead><tr><th>ë‚ ì§œ</th><th>ìœ í˜•</th><th>ìƒíƒœ</th><th>ìƒì„¸</th></tr></thead><tbody>';
  notifications.forEach(n => {
    const dt = new Date(n.created_at);
    const date = dt.toLocaleDateString('ko-KR') + ' ' + dt.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    const typeLabel = typeLabels[n.type] || n.type;
    const badgeClass = n.status === 'success' ? 'badge-confirmed' : 'badge-expired';
    const statusLabel = n.status === 'success' ? 'ì„±ê³µ' : 'ì‹¤íŒ¨';
    let detail = '';
    if (n.detail) {
      const d = typeof n.detail === 'string' ? JSON.parse(n.detail) : n.detail;
      if (d.manual) detail += '<span style="color:var(--accent);font-size:0.7rem">[ìˆ˜ë™]</span> ';
      if (d.groupId) detail += 'ID: ' + d.groupId.substring(0, 12) + '...';
      if (d.email_id) detail += 'ID: ' + d.email_id.substring(0, 12) + '...';
      if (d.mgtKey) detail += d.mgtKey;
      if (d.receipt_amount) detail += ' (' + Number(d.receipt_amount).toLocaleString() + 'ì›)';
    }
    if (n.payment_amount) detail += (detail ? ' | ' : '') + 'ê²°ì œ: ' + Number(n.payment_amount).toLocaleString() + 'ì›';
    html += '<tr><td>' + date + '</td><td>' + typeLabel + '</td><td><span class="badge ' + badgeClass + '">' + statusLabel + '</span></td><td style="font-size:0.74rem;color:#888">' + detail + '</td></tr>';
  });
  html += '</tbody></table>';
  document.getElementById('detailNotifications').innerHTML = html;
}

async function resendNotification(type) {
  if (!currentMemberId) return;
  const labels = { sms: 'SMS', email: 'ì´ë©”ì¼', cashreceipt: 'í˜„ê¸ˆì˜ìˆ˜ì¦' };
  if (!confirm(labels[type] + 'ì„(ë¥¼) ì¬ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    const res = await apiFetch('/api/admin/members/' + currentMemberId + '/resend', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type })
    });
    const data = await res.json();
    showToast(data.message || data.error || 'ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤', data.success ? 'success' : 'error');
    loadNotifications(currentMemberId);
  } catch (err) {
    showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

function switchDetailTab(tab, clickedBtn) {
  document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.detail-tab-content').forEach(t => t.classList.remove('active'));
  if (clickedBtn) {
    clickedBtn.classList.add('active');
  } else {
    // Called programmatically â€” activate the matching tab button
    const tabMap = { 'attendance': 'ì¶œì„', 'passes': 'ì´ìš©ê¶Œ', 'payments-detail': 'ê²°ì œ', 'notifications': 'ì•Œë¦¼' };
    const keyword = tabMap[tab] || tab;
    document.querySelectorAll('.detail-tab').forEach(t => {
      if (t.textContent.trim().includes(keyword)) {
        t.classList.add('active');
      }
    });
    // Fallback: just activate the first tab button if nothing matched
    if (!document.querySelector('.detail-tab.active')) {
      document.querySelector('.detail-tab').classList.add('active');
    }
  }
  document.getElementById('dtab-' + tab).classList.add('active');
}

// ========== Main Actions ==========

async function confirmPayment(id) {
  if (!confirm('ì…ê¸ˆì„ í™•ì¸í•˜ê³  ì´ìš©ê¶Œì„ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    const res = await apiFetch('/api/admin/payments/' + id + '/confirm', { method: 'POST' });
    const data = await res.json();
    if (data.success) { showToast('ì…ê¸ˆ í™•ì¸ ì™„ë£Œ', 'success'); loadDashboard(); }
    else { showToast(data.error, 'error'); }
  } catch (err) { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); }
}

async function deletePayment(id, name, amount) {
  if (!confirm(name + 'ë‹˜ì˜ ì…ê¸ˆ ë‚´ì—­(' + (amount||0).toLocaleString() + 'ì›)ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš  ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
  try {
    const res = await apiFetch('/api/admin/payments/' + id, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) { showToast('ê²°ì œ ì‚­ì œ ì™„ë£Œ', 'success'); loadDashboard(); }
    else { showToast(data.error || 'ì‚­ì œ ì‹¤íŒ¨', 'error'); }
  } catch (err) { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); }
}

async function markAttend(userId) {
  if (!confirm('í•´ë‹¹ íšŒì›ì˜ ì¶œì„ì„ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì”ì—¬ íšŸìˆ˜ -1)')) return;
  try {
    const res = await apiFetch('/api/admin/members/' + userId + '/attend', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ note: new Date().toLocaleDateString('ko-KR') + ' ìˆ˜ì—…' })
    });
    const data = await res.json();
    if (data.success) { showToast('ì¶œì„ ì²˜ë¦¬ ì™„ë£Œ', 'success'); loadDashboard(); }
    else { showToast(data.error, 'error'); }
  } catch (err) { showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); }
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
  if (tab === 'messages') { loadMessageHistory(1); }
  if (tab === 'attendance-history') { loadAttendanceHistory(1); }
  if (tab === 'bulk-sms') { loadBulkTargets(currentBulkType); }
  if (tab === 'waitlist') { loadWaitlist(1); }
}

function filterPayments(status, btn) {
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  loadPayments(status);
}

function searchPaymentsFn(){const q=document.getElementById('searchPayments').value;loadPayments('all',q);}
function searchMembersFn(){const q=document.getElementById('searchMembers').value;loadMembers(q);}

async function logout() {
  await apiFetch('/api/logout', { method: 'POST' });
  window.location.href = '/';
}

// ========== Edit / Delete ==========

let currentMemberData = null;

function toggleEditForm() {
  const form = document.getElementById('editForm');
  if (form.classList.contains('active')) {
    form.classList.remove('active');
  } else {
    if (currentMemberData) {
      document.getElementById('editName').value = currentMemberData.name || '';
      document.getElementById('editEmail').value = currentMemberData.email || '';
      document.getElementById('editPhone').value = currentMemberData.phone || '';
    }
    form.classList.add('active');
  }
}

async function saveMemberEdit() {
  if (!currentMemberId) return;
  const name = document.getElementById('editName').value.trim();
  const email = document.getElementById('editEmail').value.trim();
  const phone = document.getElementById('editPhone').value.trim();
  if (!name) { showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
  try {
    const res = await apiFetch('/api/admin/members/' + currentMemberId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, phone })
    });
    const data = await res.json();
    if (data.success) {
      showToast('íšŒì› ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      document.getElementById('editForm').classList.remove('active');
      openMemberDetail(currentMemberId);
    } else {
      showToast(data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
  } catch (err) {
    showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

function showDeleteConfirm() {
  if (!currentMemberData) return;
  document.getElementById('deleteTargetName').textContent = currentMemberData.name;
  document.getElementById('deleteConfirm').classList.add('active');
}

function hideDeleteConfirm() {
  document.getElementById('deleteConfirm').classList.remove('active');
}

async function deleteMember() {
  if (!currentMemberId) return;
  hideDeleteConfirm();
  try {
    const res = await apiFetch('/api/admin/members/' + currentMemberId, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) {
      showToast(data.message, 'success');
      closeDetail();
    } else {
      showToast(data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
  } catch (err) {
    showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

function toggleMenu(){document.querySelector('nav ul').classList.toggle('open');}

// ========== Application Edit / Delete ==========

let currentAppEditId = null;

function openAppEdit(id, name, email, phone) {
  currentAppEditId = id;
  document.getElementById('appEditName').value = name || '';
  document.getElementById('appEditEmail').value = email || '';
  document.getElementById('appEditPhone').value = phone || '';
  document.getElementById('appEditOverlay').classList.add('active');
}

function closeAppEdit() {
  currentAppEditId = null;
  document.getElementById('appEditOverlay').classList.remove('active');
}

async function saveAppEdit() {
  if (!currentAppEditId) return;
  const name = document.getElementById('appEditName').value.trim();
  const email = document.getElementById('appEditEmail').value.trim();
  const phone = document.getElementById('appEditPhone').value.trim();
  if (!name) { showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
  try {
    const res = await apiFetch('/api/admin/applications/' + currentAppEditId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, phone })
    });
    const data = await res.json();
    if (data.success) {
      showToast('ì‹ ì²­ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      closeAppEdit();
      loadApplications(document.querySelector('#tab-applications .filter-btn.active')?.textContent === 'ëŒ€ê¸°' ? 'pending' : document.querySelector('#tab-applications .filter-btn.active')?.textContent === 'ì…ê¸ˆì™„ë£Œ' ? 'paid' : 'all');
    } else {
      showToast(data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
  } catch (err) {
    showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

async function deleteApplication(id, name) {
  if (!confirm(name + 'ë‹˜ì˜ ì‹ ì²­ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    const res = await apiFetch('/api/admin/applications/' + id, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) {
      showToast(data.message, 'success');
      loadApplications(document.querySelector('#tab-applications .filter-btn.active')?.textContent === 'ëŒ€ê¸°' ? 'pending' : document.querySelector('#tab-applications .filter-btn.active')?.textContent === 'ì…ê¸ˆì™„ë£Œ' ? 'paid' : 'all');
      loadStats();
    } else {
      showToast(data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
  } catch (err) {
    showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

// ========== CSV Export ==========

async function exportCSV(type) {
  try {
    let rows = [];
    let filename = '';
    const today = new Date().toISOString().slice(0, 10);

    if (type === 'payments') {
      showToast('ê²°ì œ ë°ì´í„° ë‚´ë³´ë‚´ëŠ” ì¤‘...', '');
      const res = await apiFetch('/api/admin/payments?status=all&page=1&limit=9999');
      const data = await res.json();
      const payments = data.payments || [];
      rows.push(['ë‚ ì§œ', 'íšŒì›ëª…', 'ì „í™”ë²ˆí˜¸', 'ì…ê¸ˆìëª…', 'ê¸ˆì•¡', 'ìƒíƒœ', 'í™•ì¸ì¼']);
      payments.forEach(p => {
        rows.push([
          new Date(p.created_at).toLocaleDateString('ko-KR'),
          p.user_name || '',
          p.user_phone || '',
          p.depositor_name || '',
          p.amount,
          p.status === 'confirmed' ? 'í™•ì¸ì™„ë£Œ' : p.status === 'underpaid' ? 'ë¶€ì¡±' : 'ëŒ€ê¸°',
          p.confirmed_at ? new Date(p.confirmed_at).toLocaleDateString('ko-KR') : ''
        ]);
      });
      filename = 'ê²°ì œë‚´ì—­_' + today + '.csv';
    }

    else if (type === 'members') {
      showToast('íšŒì› ë°ì´í„° ë‚´ë³´ë‚´ëŠ” ì¤‘...', '');
      const res = await apiFetch('/api/admin/members?limit=9999');
      const data = await res.json();
      const members = data.members || [];
      rows.push(['ì´ë¦„', 'ì´ë©”ì¼', 'ì „í™”ë²ˆí˜¸', 'ì”ì—¬íšŸìˆ˜', 'ì´ì¶œì„', 'ê°€ì…ì¼']);
      members.forEach(m => {
        rows.push([
          m.name,
          m.email,
          m.phone,
          m.remaining_classes,
          m.total_attended,
          new Date(m.created_at).toLocaleDateString('ko-KR')
        ]);
      });
      filename = 'íšŒì›ëª©ë¡_' + today + '.csv';
    }

    else if (type === 'applications') {
      showToast('ì‹ ì²­ ë°ì´í„° ë‚´ë³´ë‚´ëŠ” ì¤‘...', '');
      const res = await apiFetch('/api/admin/applications?status=all&limit=9999');
      const data = await res.json();
      const apps = data.applications || [];
      rows.push(['ë‚ ì§œ', 'ì´ë¦„', 'ì´ë©”ì¼', 'ì „í™”ë²ˆí˜¸', 'ìƒíƒœ']);
      apps.forEach(a => {
        rows.push([
          new Date(a.created_at).toLocaleDateString('ko-KR'),
          a.name,
          a.email,
          a.phone,
          a.status === 'paid' ? 'ì…ê¸ˆì™„ë£Œ' : 'ëŒ€ê¸°'
        ]);
      });
      filename = 'ì‹ ì²­ëª©ë¡_' + today + '.csv';
    }

    if (rows.length <= 1) {
      showToast('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
      return;
    }

    // BOM + CSV
    const csvContent = '\uFEFF' + rows.map(r => r.map(v => '"' + String(v).replace(/"/g, '""') + '"').join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    URL.revokeObjectURL(link.href);
    showToast(filename + ' ë‹¤ìš´ë¡œë“œ ì™„ë£Œ (' + (rows.length - 1) + 'ê±´)', 'success');
  } catch (err) {
    console.error('CSV export error:', err);
    showToast('CSV ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨', 'error');
  }
}

// ===================== ë‹¨ì²´ SMS =====================
let bulkTargets = [];
let currentBulkType = 'active';

function switchBulkType(type, btn) {
  currentBulkType = type;
  document.querySelectorAll('#tab-bulk-sms .filter-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  loadBulkTargets(type);
}

async function loadBulkTargets(type) {
  try {
    const res = await apiFetch('/api/admin/bulk-sms/targets?type=' + (type || 'active'));
    const data = await res.json();
    bulkTargets = data.members || [];
    document.getElementById('bulkTargetCount').textContent = bulkTargets.length;
    var listHtml = '';
    bulkTargets.forEach(function(m) {
      var maskedPhone = m.phone ? m.phone.replace(/(\d{3})(\d{3,4})(\d{4})/, '$1-****-$3') : '-';
      listHtml += escapeHtml(m.name) + ' (' + maskedPhone + ')';
      if (type === 'active') listHtml += ' Â· ì”ì—¬ ' + m.remaining_classes + 'íšŒ';
      listHtml += '<br>';
    });
    document.getElementById('bulkTargetList').innerHTML = listHtml || '<span style="color:#aaa">ëŒ€ìƒ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</span>';
    document.getElementById('bulkResult').style.display = 'none';
  } catch (err) {
    console.error('Load bulk targets error:', err);
    showToast('ëŒ€ìƒ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨', 'error');
  }
}

function toggleBulkTargetList() {
  var el = document.getElementById('bulkTargetList');
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function updateBulkCharCount() {
  var msg = document.getElementById('bulkSmsMessage').value;
  var len = msg.length;
  var type = len > 90 ? 'LMS' : 'SMS';
  document.getElementById('bulkCharCount').textContent = len + 'ì (' + type + ')';
}

function previewBulkSms() {
  var msg = document.getElementById('bulkSmsMessage').value;
  if (!msg.trim()) { showToast('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
  var name = bulkTargets.length > 0 ? bulkTargets[0].name : 'í™ê¸¸ë™';
  var preview = msg.replace(/\{name\}/g, name);
  var previewEl = document.getElementById('bulkPreview');
  previewEl.textContent = preview;
  previewEl.style.display = 'block';
}

async function sendBulkSms() {
  var msg = document.getElementById('bulkSmsMessage').value;
  if (!msg.trim()) { showToast('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
  if (bulkTargets.length === 0) { showToast('ë°œì†¡ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }
  var label = currentBulkType === 'active' ? 'ì´ìš©ê¶Œ ë³´ìœ ' : 'ì´ìš©ê¶Œ ë¯¸ë³´ìœ ';
  if (!confirm(label + ' íšŒì› ' + bulkTargets.length + 'ëª…ì—ê²Œ SMSë¥¼ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

  try {
    showToast('ë°œì†¡ ì¤‘... (' + bulkTargets.length + 'ëª…)', '');
    var res = await apiFetch('/api/admin/bulk-sms', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type: currentBulkType, message: msg })
    });
    var data = await res.json();
    if (data.success) {
      var resultHtml = '<div style="font-size:0.82rem;font-weight:300;line-height:1.8">';
      resultHtml += 'ì „ì²´ <strong>' + data.total + '</strong>ëª… Â· ';
      resultHtml += 'ì„±ê³µ <strong style="color:#2e7d32">' + data.sent + '</strong>ëª… Â· ';
      resultHtml += 'ì‹¤íŒ¨ <strong style="color:#c44">' + data.failed + '</strong>ëª…</div>';
      if (data.details && data.details.length > 0) {
        resultHtml += '<div style="margin-top:8px;max-height:150px;overflow-y:auto;font-size:0.75rem;font-weight:300;line-height:1.8">';
        data.details.forEach(function(d) {
          var icon = d.status === 'success' ? 'âœ…' : 'âŒ';
          resultHtml += icon + ' ' + escapeHtml(d.name) + '<br>';
        });
        resultHtml += '</div>';
      }
      document.getElementById('bulkResultContent').innerHTML = resultHtml;
      document.getElementById('bulkResult').style.display = 'block';
      showToast(data.sent + 'ëª… ë°œì†¡ ì™„ë£Œ', 'success');
    } else {
      showToast(data.error || 'ë°œì†¡ ì‹¤íŒ¨', 'error');
    }
  } catch (err) {
    console.error('Bulk SMS error:', err);
    showToast('ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

// ===================== ìˆ˜ì—… ì°¸ì—¬ ì´ë ¥ =====================
let attPage = 1;
const ATT_PAGE_SIZE = 30;

async function loadAttendanceHistory(page) {
  if (page !== undefined) attPage = page;
  showLoading('attendanceHistoryList');
  try {
    const dateFrom = document.getElementById('attDateFrom').value;
    const dateTo = document.getElementById('attDateTo').value;
    const search = document.getElementById('searchAttendance').value;
    let url = '/api/admin/attendance-history?page=' + attPage + '&limit=' + ATT_PAGE_SIZE;
    if (dateFrom) url += '&from=' + dateFrom;
    if (dateTo) url += '&to=' + dateTo;
    if (search) url += '&search=' + encodeURIComponent(search);

    const res = await apiFetch(url);
    if (!res.ok) {
      document.getElementById('attendanceHistoryList').innerHTML = '<div class="empty-state">ìˆ˜ì—… ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (HTTP ' + res.status + ')</div>';
      document.getElementById('attendancePagination').innerHTML = '';
      return;
    }
    const data = await res.json();
    if (data.error) {
      document.getElementById('attendanceHistoryList').innerHTML = '<div class="empty-state">' + escapeHtml(data.error) + '</div>';
      document.getElementById('attendancePagination').innerHTML = '';
      return;
    }
    const items = data.attendance || [];
    const total = (data.pagination && data.pagination.total) || 0;
    const totalPages = Math.ceil(total / ATT_PAGE_SIZE) || 1;

    if (items.length === 0) {
      document.getElementById('attendanceHistoryList').innerHTML = '<div class="empty-state">ìˆ˜ì—… ì°¸ì—¬ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      document.getElementById('attendancePagination').innerHTML = '';
      return;
    }

    let html = '<div style="margin-bottom:12px;font-size:0.78rem;color:#888">ì´ ' + total + 'ê±´</div>';
    html += '<table><thead><tr><th>ë‚ ì§œ</th><th>ì‹œê°„</th><th>íšŒì›ëª…</th><th>ì´ë©”ì¼</th><th>ì—°ë½ì²˜</th><th>ì´ìš©ê¶Œ ìƒíƒœ</th><th>ë¹„ê³ </th></tr></thead><tbody>';

    items.forEach(function(a) {
      var dt = new Date(a.attended_at);
      var date = dt.toLocaleDateString('ko-KR');
      var time = dt.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
      var passInfo = a.pass_status ? (a.pass_remaining + '/' + a.total_classes + 'íšŒ') : '-';
      var passBadge = a.pass_status === 'active' ? 'badge-active' : a.pass_status === 'used' ? 'badge-used' : 'badge-expired';
      var passLabel = a.pass_status === 'active' ? 'í™œì„±' : a.pass_status === 'used' ? 'ì†Œì§„' : a.pass_status === 'expired' ? 'ë§Œë£Œ' : a.pass_status === 'cancelled' ? 'ì·¨ì†Œ' : (a.pass_status || '-');
      var note = a.note || '';
      if (a.zoom_meeting_uuid) note = (note ? note + ' ' : '') + 'ğŸ¥ Zoom';

      html += '<tr>';
      html += '<td style="white-space:nowrap">' + date + '</td>';
      html += '<td>' + time + '</td>';
      html += '<td><strong>' + escapeHtml(a.user_name || '-') + '</strong></td>';
      html += '<td style="font-size:0.76rem">' + escapeHtml(a.user_email || '-') + '</td>';
      html += '<td style="font-size:0.76rem">' + escapeHtml(a.user_phone || '-') + '</td>';
      html += '<td><span class="badge ' + passBadge + '">' + passLabel + '</span> <span style="font-size:0.72rem;color:#888">' + passInfo + '</span></td>';
      html += '<td style="font-size:0.76rem;color:#888">' + escapeHtml(note) + '</td>';
      html += '</tr>';
    });

    html += '</tbody></table>';
    document.getElementById('attendanceHistoryList').innerHTML = html;
    renderPagination('attendancePagination', attPage, totalPages, 'goAttPage');
  } catch (err) {
    console.error('Attendance history error:', err);
    document.getElementById('attendanceHistoryList').innerHTML = '<div class="empty-state">ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
  }
}

function goAttPage(page) { loadAttendanceHistory(page); }

// ===================== ìˆ˜ë™ ì´ìš©ê¶Œ ì°¨ê° =====================

async function deductCredits() {
  if (!currentMemberId) return;
  var credits = parseInt(document.getElementById('deductCreditsCount').value);
  var note = document.getElementById('deductCreditsNote').value;
  if (!credits || credits < 1) { showToast('ì°¨ê°í•  íšŸìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
  if (!confirm(credits + 'íšŒë¥¼ ì°¨ê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

  try {
    var res = await apiFetch('/api/admin/members/' + currentMemberId + '/deduct-credits', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ credits: credits, note: note })
    });
    var data = await res.json();
    if (data.success) {
      showToast(data.deducted + 'íšŒê°€ ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ ì”ì—¬: ' + data.total_remaining + 'íšŒ', 'success');
      document.getElementById('deductCreditsCount').value = '1';
      document.getElementById('deductCreditsNote').value = '';
      openMemberDetail(currentMemberId);
      loadStats();
    } else {
      showToast(data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
  } catch (err) {
    showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

// ===================== ë©”ì‹œì§€ ì´ë ¥ =====================
let msgPage = 1;
let currentMsgType = 'all';
const MSG_PAGE_SIZE = 30;

async function loadMessageHistory(page) {
  if (page !== undefined) msgPage = page;
  showLoading('messageList');
  try {
    const dateFrom = document.getElementById('msgDateFrom').value;
    const dateTo = document.getElementById('msgDateTo').value;
    const search = document.getElementById('searchMessages').value;
    let url = '/api/admin/message-history?page=' + msgPage + '&limit=' + MSG_PAGE_SIZE + '&type=' + currentMsgType;
    if (dateFrom) url += '&from=' + dateFrom;
    if (dateTo) url += '&to=' + dateTo;
    if (search) url += '&search=' + encodeURIComponent(search);

    const res = await apiFetch(url);
    if (!res.ok) {
      const errText = await res.text();
      console.error('Message history API error:', res.status, errText);
      document.getElementById('messageList').innerHTML = '<div class="empty-state">ë©”ì‹œì§€ ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (HTTP ' + res.status + ')</div>';
      document.getElementById('messagePagination').innerHTML = '';
      return;
    }
    const data = await res.json();
    if (data.error) {
      document.getElementById('messageList').innerHTML = '<div class="empty-state">' + escapeHtml(data.error) + '</div>';
      document.getElementById('messagePagination').innerHTML = '';
      return;
    }
    const messages = data.messages || [];
    const total = (data.pagination && data.pagination.total) || 0;
    const totalPages = Math.ceil(total / MSG_PAGE_SIZE) || 1;

    if (messages.length === 0) {
      document.getElementById('messageList').innerHTML = '<div class="empty-state">ë©”ì‹œì§€ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      document.getElementById('messagePagination').innerHTML = '';
      return;
    }

    let html = '<div style="margin-bottom:12px;font-size:0.78rem;color:#888">ì´ ' + total + 'ê±´</div>';
    html += '<table><thead><tr><th>ë‚ ì§œ</th><th>ìˆ˜ì‹ ì</th><th>ì—°ë½ì²˜</th><th>ìœ í˜•</th><th>ë¶„ë¥˜</th><th>ìƒíƒœ</th><th>ë°œì†¡ë°©ì‹</th></tr></thead><tbody>';

    messages.forEach(function(m) {
      var dt = new Date(m.created_at);
      var date = dt.toLocaleDateString('ko-KR');
      var time = dt.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

      // ìœ í˜• í‘œì‹œ
      var typeIcons = { sms: 'ğŸ“±', email: 'ğŸ“§', cashreceipt: 'ğŸ§¾' };
      var typeLabels = { sms: 'SMS', email: 'ì´ë©”ì¼', cashreceipt: 'í˜„ê¸ˆì˜ìˆ˜ì¦' };
      var typeIcon = typeIcons[m.type] || 'ğŸ“¨';
      var typeLabel = typeLabels[m.type] || m.type;

      // ë¶„ë¥˜ (sub_type)
      var subTypeLabels = {
        'sms': 'SMS',
        'email': 'ì´ë©”ì¼',
        'cashreceipt': 'í˜„ê¸ˆì˜ìˆ˜ì¦',
        'reminder': 'ìˆ˜ì—… ë¦¬ë§ˆì¸ë”',
        'journaling_first': 'ì €ë„ë§(ì²« ìˆ˜ì—…)',
        'journaling_recurring': 'ì €ë„ë§(ë°˜ë³µ)',
        'care_expiring_7d': 'ë§Œë£Œ 7ì¼ ì „',
        'care_inactive_7d': 'ë¯¸ì°¸ì„ ì•ˆë‚´',
        'care_renewal_1left': 'ì”ì—¬ 1íšŒ'
      };
      var subLabel = subTypeLabels[m.sub_type] || m.sub_type || '-';
      // detailì—ì„œ source í™•ì¸
      if (m.detail) {
        var d = typeof m.detail === 'string' ? JSON.parse(m.detail) : m.detail;
        if (d.source === 'journaling') subLabel = 'ì €ë„ë§(' + (d.sms_type || '') + ')';
        if (d.source === 'care') subLabel = 'ì¼€ì–´(' + (d.sms_type || '') + ')';
        if (d.bulk) subLabel += ' [ë‹¨ì²´]';
      }

      // ìƒíƒœ
      var statusBadge = m.status === 'success'
        ? '<span class="badge badge-confirmed">ì„±ê³µ</span>'
        : '<span class="badge badge-expired">ì‹¤íŒ¨</span>';

      // ë°œì†¡ ë°©ì‹
      var methodLabels = { auto: 'ìë™', manual: 'ìˆ˜ë™', bulk: 'ë‹¨ì²´' };
      var methodLabel = methodLabels[m.send_method] || m.send_method || '-';

      html += '<tr>';
      html += '<td style="white-space:nowrap">' + date + '<br><span style="font-size:0.7rem;color:#999">' + time + '</span></td>';
      html += '<td>' + escapeHtml(m.user_name || '-') + '</td>';
      html += '<td style="font-size:0.76rem">' + escapeHtml(m.type === 'email' ? (m.user_email || '-') : (m.user_phone || '-')) + '</td>';
      html += '<td>' + typeIcon + ' ' + typeLabel + '</td>';
      html += '<td style="font-size:0.76rem">' + escapeHtml(subLabel) + '</td>';
      html += '<td>' + statusBadge + '</td>';
      html += '<td style="font-size:0.76rem">' + methodLabel + '</td>';
      html += '</tr>';
    });

    html += '</tbody></table>';
    document.getElementById('messageList').innerHTML = html;
    renderPagination('messagePagination', msgPage, totalPages, 'goMsgPage');
  } catch (err) {
    console.error('Message history error:', err);
    document.getElementById('messageList').innerHTML = '<div class="empty-state">ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
  }
}

function goMsgPage(page) { loadMessageHistory(page); }

function filterMessages(type, btn) {
  currentMsgType = type;
  document.querySelectorAll('#tab-messages .filter-btn').forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  msgPage = 1;
  loadMessageHistory();
}

// ===================== WAITLIST MANAGEMENT =====================
let waitlistTypeFilter = 'all';
let waitlistStatusFilter = 'all';
let waitlistPage = 1;
const WAITLIST_PAGE_SIZE = 50;

async function loadWaitlist(page) {
  if (page !== undefined) waitlistPage = page;
  document.getElementById('waitlistTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:#888">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</td></tr>';
  try {
    const search = document.getElementById('searchWaitlist').value;
    let url = '/api/admin/waitlist?page=' + waitlistPage + '&limit=' + WAITLIST_PAGE_SIZE;
    if (waitlistTypeFilter !== 'all') url += '&membership_type=' + waitlistTypeFilter;
    if (waitlistStatusFilter !== 'all') url += '&status=' + waitlistStatusFilter;
    if (search) url += '&search=' + encodeURIComponent(search);

    const res = await apiFetch(url);
    const data = await res.json();
    const items = data.waitlist || [];
    const total = (data.pagination && data.pagination.total) || 0;
    const totalPages = Math.ceil(total / WAITLIST_PAGE_SIZE) || 1;

    if (items.length === 0) {
      document.getElementById('waitlistTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:#888">ëŒ€ê¸°ìê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
      document.getElementById('waitlistPagination').innerHTML = '';
      return;
    }

    let html = '';
    items.forEach(function(w) {
      var dt = new Date(w.created_at);
      var date = dt.toLocaleDateString('ko-KR');
      var typeBadge = w.membership_type === 'vip'
        ? '<span class="badge" style="background:#fffbe6;color:#c4a35a;border:1px solid #c4a35a">VIP</span>'
        : '<span class="badge" style="background:#f3e5f5;color:#7b1fa2;border:1px solid #ce93d8">Premium</span>';
      var statusLabels = { pending: 'ëŒ€ê¸°ì¤‘', contacted: 'ì—°ë½ì™„ë£Œ', converted: 'ì „í™˜ì™„ë£Œ' };
      var statusBadges = { pending: 'badge-pending', contacted: 'badge-active', converted: 'badge-confirmed' };
      var statusBadge = '<span class="badge ' + (statusBadges[w.status] || 'badge-pending') + '">' + (statusLabels[w.status] || w.status) + '</span>';

      html += '<tr>';
      html += '<td>' + escapeHtml(w.name) + '</td>';
      html += '<td style="font-size:0.76rem">' + escapeHtml(w.phone) + '</td>';
      html += '<td style="font-size:0.76rem">' + escapeHtml(w.email) + '</td>';
      html += '<td>' + typeBadge + '</td>';
      html += '<td>' + statusBadge + '</td>';
      html += '<td style="font-size:0.76rem;white-space:nowrap">' + date + '</td>';
      html += '<td style="white-space:nowrap">';
      if (w.status === 'pending') html += '<button class="action-btn small" onclick="updateWaitlistStatus(' + w.id + ',\'contacted\')">ì—°ë½ì™„ë£Œ</button> ';
      if (w.status === 'contacted') html += '<button class="action-btn small" onclick="updateWaitlistStatus(' + w.id + ',\'converted\')">ì „í™˜ì™„ë£Œ</button> ';
      if (w.status !== 'converted') html += '<button class="action-btn small danger" onclick="deleteWaitlistItem(' + w.id + ')">ì‚­ì œ</button>';
      html += '</td>';
      html += '</tr>';
    });

    document.getElementById('waitlistTableBody').innerHTML = html;
    renderPagination('waitlistPagination', waitlistPage, totalPages, 'goWaitlistPage');
  } catch (err) {
    console.error('Waitlist load error:', err);
    document.getElementById('waitlistTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:#c44">ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</td></tr>';
  }
}

function goWaitlistPage(page) { loadWaitlist(page); }

function filterWaitlist(type, btn) {
  waitlistTypeFilter = type;
  document.querySelectorAll('#tab-waitlist .filter-row:first-child .filter-btn').forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  waitlistPage = 1;
  loadWaitlist();
}

function filterWaitlistStatus(status, btn) {
  waitlistStatusFilter = status;
  document.querySelectorAll('#tab-waitlist .filter-row:nth-child(2) .filter-btn').forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  waitlistPage = 1;
  loadWaitlist();
}

async function updateWaitlistStatus(id, status) {
  var statusLabels = { contacted: 'ì—°ë½ì™„ë£Œ', converted: 'ì „í™˜ì™„ë£Œ' };
  if (!confirm(statusLabels[status] + ' ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    const res = await apiFetch('/api/admin/waitlist/' + id, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: status })
    });
    const data = await res.json();
    if (data.success) { loadWaitlist(); }
    else { alert(data.error || 'ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨'); }
  } catch (err) { alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'); }
}

async function deleteWaitlistItem(id) {
  if (!confirm('ì´ ëŒ€ê¸°ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    const res = await apiFetch('/api/admin/waitlist/' + id, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) { loadWaitlist(); }
    else { alert(data.error || 'ì‚­ì œ ì‹¤íŒ¨'); }
  } catch (err) { alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'); }
}

checkAuth();
</script>
</body>
</html>
